<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Petualangan Matematika Doraemon: Arcade</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap');

        :root {
            --primary: #0096e7; /* Doraemon Blue */
            --secondary: #e74c3c; /* Red */
            --accent: #f1c40f; /* Bell Gold */
            --text: #333;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Nunito', sans-serif;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
            width: 100vw;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        /* --- UI ELEMENTS (HUD) --- */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 5;
        }

        .hud {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            font-family: 'Fredoka One', cursive;
            font-size: 18px;
            color: white;
            text-shadow: 2px 2px 4px #000;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
        }

        .score-box {
            display: flex;
            flex-direction: column;
            gap: 2px;
            text-align: left;
        }
        
        .arcade-score { color: #fff; text-shadow: 1px 1px 0 #0096e7; }

        .mission-box {
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid var(--accent);
            color: var(--accent);
            text-align: center;
            font-size: 16px;
        }

        /* --- CONTROLS OVERLAY (MOBILE) --- */
        #controls-hint {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.7);
            font-family: 'Nunito', sans-serif;
            font-size: 14px;
            pointer-events: none;
            display: none;
            background: rgba(0,0,0,0.5);
            padding: 10px 0;
        }

        /* PANEL SOAL MATEMATIKA */
        #question-panel {
            position: absolute;
            bottom: 50px; 
            top: auto;    
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); 
            border: 4px solid var(--accent); 
            padding: 8px 25px; 
            border-radius: 30px;
            font-family: 'Fredoka One', cursive;
            font-size: 1.5rem; 
            color: var(--primary);
            text-shadow: 1px 1px 0px rgba(0,0,0,0.1);
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            pointer-events: none;
            display: none; 
            animation: slideUpFade 0.5s;
            z-index: 20; 
            white-space: nowrap;
        }

        @keyframes slideUpFade {
            0% { transform: translateX(-50%) translateY(20px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* LEVEL CLEAR OVERLAY */
        #level-clear-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 150, 231, 0.95);
            z-index: 50;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            animation: fadeIn 0.5s;
        }
        #level-clear-overlay h1 {
            font-family: 'Fredoka One', cursive;
            font-size: 2.5rem;
            color: #fff;
            text-shadow: 4px 4px 0 var(--accent);
            margin: 0;
            text-align: center;
        }
        #level-clear-overlay p {
            font-family: 'Fredoka One', cursive;
            font-size: 1.2rem;
            color: #fff;
            margin-top: 10px;
            text-align: center;
        }

        /* --- START SCREEN --- */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://i.imgur.com/gwzk9w3.jpeg');
            background-size: cover;
            background-position: center;
            z-index: 40;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .dev-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 40px;
            text-align: center;
            max-width: 400px;
            width: 85%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 5px solid var(--primary);
            animation: slideUp 0.8s ease-out;
        }

        .dev-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 5px solid var(--accent);
            object-fit: cover;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .dev-name { font-family: 'Fredoka One'; font-size: 1.8rem; color: var(--primary); margin: 0; }
        .dev-title { font-weight: bold; color: #555; margin: 5px 0 20px 0; font-size: 1rem; }

        .btn-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }

        .btn-start {
            background: linear-gradient(to bottom, #ff9800, #f57c00);
            color: white;
            font-family: 'Fredoka One', cursive;
            font-size: 1.4rem;
            padding: 15px 35px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #e65100;
            transition: transform 0.1s;
        }
        .btn-start:active { transform: translateY(5px); box-shadow: 0 2px 0 #e65100; }

        /* --- MAP SCREEN --- */
        #map-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://i.imgur.com/gwzk9w3.jpeg') no-repeat center center;
            background-size: cover;
            z-index: 10; display: none; pointer-events: auto;
        }
        .map-title {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            font-family: 'Fredoka One'; font-size: 1.8rem; color: #fff;
            text-shadow: 3px 3px 0 var(--primary), -1px -1px 0 #000;
            background: rgba(0, 0, 0, 0.4); padding: 5px 30px;
            border-radius: 50px; border: 3px solid #fff; z-index: 20;
            width: 80%; text-align: center;
        }
        
        #diff-selector-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 25; display: flex; gap: 5px;
            background: rgba(255, 255, 255, 0.85); padding: 8px 15px;
            border-radius: 30px; border: 3px solid var(--primary);
            width: 90%; justify-content: center;
        }
        .diff-btn {
            border: none; padding: 6px 10px; border-radius: 12px;
            font-family: 'Fredoka One'; font-size: 0.8rem; cursor: pointer; color: white; opacity: 0.8;
            flex: 1;
        }
        .diff-btn.active { opacity: 1; transform: scale(1.05); border: 2px solid white; z-index: 2; }
        
        .map-point {
            position: absolute; width: 60px; height: 60px;
            background: radial-gradient(circle at 30% 30%, #fff, #f0f0f0);
            border: 4px solid var(--primary); border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 15px var(--accent); display: flex; justify-content: center; align-items: center;
            z-index: 15; animation: float 3s infinite;
        }
        .map-point:hover { transform: scale(1.15); background: #fff; z-index: 25; }
        .map-point b { font-size: 30px; color: var(--primary); font-family: 'Fredoka One'; }
        
        .map-label {
            position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(to right, #0096e7, #005f9e);
            color: white; padding: 5px 10px; border-radius: 15px;
            font-family: 'Fredoka One'; font-size: 12px; white-space: nowrap; 
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 30;
        }
        .map-point:hover .map-label { opacity: 1; bottom: -50px; }

        /* Map Locations */
        #level-1 { bottom: 25%; left: 10%; border-color: #4CAF50; } 
        #level-2 { top: 40%; left: 15%; border-color: #2196F3; }   
        #level-3 { top: 15%; left: 50%; transform: translateX(-50%); border-color: #FFC107; }   
        #level-4 { top: 30%; right: 10%; border-color: #FF5722; }  
        #level-5 { bottom: 40%; right: 15%; border-color: #9C27B0; } 
        #level-6 { bottom: 15%; left: 50%; transform: translateX(-50%); border-color: #E91E63; } 

        @keyframes floatSide { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        #level-1, #level-2, #level-4, #level-5 { animation: floatSide 3s infinite; }

        /* --- PORTAL & EFFECTS --- */
        #portal-layer { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 60; align-items: center; justify-content: center; flex-direction: column; }
        #portal-image { max-width: 80%; }
        .portal-text { color: white; font-family: 'Fredoka One'; font-size: 1.5rem; margin-top: 20px; text-align: center; }

        #shooting-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 30; pointer-events: none; }
        #muzzle-flash { position: absolute; width: 60px; height: 60px; background: radial-gradient(circle, #fff 30%, #ffeb3b 60%, transparent 80%); border-radius: 50%; display: none; z-index: 35; }
        #laser-beam { position: absolute; height: 15px; background: linear-gradient(to right, #fff, #00e5ff, #0096e7); box-shadow: 0 0 25px #00e5ff; border-radius: 10px; display: none; opacity: 1; z-index: 34; transform-origin: left center; }
        #feedback-overlay { display: none; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-family: 'Fredoka One'; font-size: 3rem; z-index: 80; text-shadow: 3px 3px 0 #000; width: 100%; text-align: center; }
        
        .hud-btn { background: rgba(0,0,0,0.5); border: 2px solid white; color: white; width: 35px; height: 35px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; justify-content: center; align-items: center; pointer-events: auto; }
        #top-controls { display: flex; gap: 5px; }
        
        #dev-info-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; }
        .btn-close {
            background: #e74c3c; color: white; font-family: 'Fredoka One'; padding: 8px 20px;
            border: none; border-radius: 20px; cursor: pointer; margin-top: 15px; font-size: 1.2rem;
            box-shadow: 0 4px 0 #c0392b;
        }

    </style>
</head>
<body>

    <!-- AUDIO SYSTEM -->
    <audio id="bgm-menu" loop>
        <source src="https://github.com/jeckyemerson34-JQ/lagudoraemon/raw/refs/heads/main/Playing%20Doraemon%20theme%20song%20with%20different%20instrument.%20%23relaxing%20%23funny%20-%203DArt.mp3" type="audio/mpeg">
    </audio>
    <audio id="bgm-battle" loop>
        <source src="https://github.com/jeckyemerson34-JQ/Lagu-perang-Doraemon/raw/refs/heads/main/Zanda%20Claus%20Suite%20by%20Kan%20Sawada%20-%20DORAEMON%20Nobita%20&%20the%20New%20Steel%20Troops%202011%20OST.%20-%20S2P%20%5BThai%20Lyrics%5D%20infinity.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="sfx-laser"><source src="https://assets.mixkit.co/sfx/preview/mixkit-laser-weapon-shot-1681.mp3" type="audio/mpeg"></audio>
    <audio id="sfx-explosion"><source src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-explosion-2759.mp3" type="audio/mpeg"></audio>
    <audio id="sfx-correct"><source src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-score-interface-217.mp3" type="audio/mpeg"></audio>
    <audio id="sfx-wrong"><source src="https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-game-over-3068.mp3" type="audio/mpeg"></audio>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="question-panel">
            <span id="question-text">5 + 5 = ?</span>
        </div>

        <div id="controls-hint">
            Sentuh Musuh dengan Jawaban Benar untuk Menembak!
        </div>

        <div id="shooting-overlay">
            <div id="muzzle-flash"></div>
            <div id="laser-beam"></div>
        </div>

        <div class="ui-layer">
            <div class="hud">
                <div class="score-box">
                    <div id="lives-display">‚ù§Ô∏è ‚ù§Ô∏è ‚ù§Ô∏è</div>
                    <div id="score-display" class="arcade-score" style="display:none;">Poin: 0</div>
                </div>
                
                <div id="mission-display" class="mission-box">Misi: 0/10</div>

                <div id="top-controls">
                    <button class="hud-btn" id="btn-dev-game" onclick="showDevInfo()">üë§</button>
                    <button class="hud-btn" id="btn-music" onclick="toggleMusic()">üéµ</button>
                    <button class="hud-btn" id="btn-fullscreen" onclick="toggleFullscreen()">‚õ∂</button>
                    <button class="hud-btn" id="btn-home" onclick="backToMap()" style="display:none; background:orange;">üè†</button>
                </div>
            </div>
        </div>

        <div id="level-clear-overlay">
            <h1 id="level-clear-title">Misi Selesai!</h1>
            <p id="level-clear-text">Menuju Kerajaan Berikutnya...</p>
        </div>

        <div id="start-screen">
            <div class="dev-card">
                <img src="https://i.imgur.com/FS8MNJa.jpeg" alt="Jecky Emerson" class="dev-photo">
                <h1 class="dev-name">Jecky Emerson</h1>
                <p class="dev-title">Duta Teknologi Kemendikdasmen<br>(Guru Pejuang Digital)</p>
                
                <h1 style="font-family:'Fredoka One'; color:var(--primary); font-size:2rem; line-height:1.2; margin-bottom:30px; text-shadow: 2px 2px 0 #eee;">
                    Petualangan Matematika<br>Doraemon
                </h1>

                <div class="btn-group">
                    <button class="btn-start" onclick="enterMap()">MULAI PETUALANGAN</button>
                </div>
            </div>
        </div>

        <div id="map-screen">
            <h1 class="map-title">Peta Kerajaan</h1>
            <div id="map-controls" style="position:absolute; top:20px; right:20px; display:flex; gap:10px; z-index:30;">
                 <button class="hud-btn" onclick="showDevInfo()">üë§</button>
                 <button class="hud-btn" onclick="toggleMusic()">üéµ</button>
            </div>
            
            <div id="diff-selector-container">
                <button class="diff-btn" id="diff-easy" style="background:#2ecc71" onclick="setGlobalDifficulty('easy')">MUDAH</button>
                <button class="diff-btn active" id="diff-med" style="background:#f39c12" onclick="setGlobalDifficulty('medium')">SEDANG</button>
                <button class="diff-btn" id="diff-hard" style="background:#e74c3c" onclick="setGlobalDifficulty('hard')">SULIT</button>
            </div>
            <div class="map-point" id="level-1" onclick="startAdventure('tambah')"><b>+</b><div class="map-label">Penjumlahan</div></div>
            <div class="map-point" id="level-2" onclick="startAdventure('kurang')"><b>-</b><div class="map-label">Pengurangan</div></div>
            <div class="map-point" id="level-3" onclick="startAdventure('kali')"><b>√ó</b><div class="map-label">Perkalian</div></div>
            <div class="map-point" id="level-4" onclick="startAdventure('bagi')"><b>√∑</b><div class="map-label">Pembagian</div></div>
            <div class="map-point" id="level-5" onclick="startAdventure('pangkat2')"><b>x¬≤</b><div class="map-label">Pangkat 2</div></div>
            <div class="map-point" id="level-6" onclick="startAdventure('akar3')"><b>¬≥‚àö</b><div class="map-label">Akar 3</div></div>
        </div>

        <div id="dev-info-overlay">
            <div class="dev-card">
                <img src="https://i.imgur.com/FS8MNJa.jpeg" class="dev-photo">
                <h1 class="dev-name">Jecky Emerson</h1>
                <p class="dev-title">Duta Teknologi Kemendikdasmen<br>(Guru Pejuang Digital)</p>
                <button class="btn-close" onclick="closeDevInfo()">TUTUP</button>
            </div>
        </div>

        <div id="portal-layer">
            <img id="portal-image" src="" alt="Portal Ajaib">
            <div class="portal-text">Menuju Luar Angkasa...</div>
        </div>

        <div id="feedback-overlay"></div>
    </div>

    <script>
        // --- ASSETS ---
        const portalImages = ['https://i.imgur.com/qylDprq.png', 'https://i.imgur.com/Acj3YDv.png', 'https://i.imgur.com/ha76MIc.png', 'https://i.imgur.com/7RggQ70.png'];
        const alienImg = new Image(); alienImg.src = 'https://imgur.com/Gd7cSJT.png';
        const playerImg = new Image(); playerImg.src = 'https://i.imgur.com/65WLA6o.png'; 

        // --- AUDIO ---
        const menuMusic = document.getElementById('bgm-menu');
        const battleMusic = document.getElementById('bgm-battle');
        const sfxLaser = document.getElementById('sfx-laser');
        const sfxExplosion = document.getElementById('sfx-explosion');
        const sfxCorrect = document.getElementById('sfx-correct');
        const sfxWrong = document.getElementById('sfx-wrong');
        let isMusicOn = true;
        let isGameActive = false;

        // --- GAME CONFIG ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let animationId;
        let gameSpeed = 1.0; 
        let score = 0; 
        let lives = 3;
        let isPaused = false;
        let currentTopic = 'tambah';
        let currentDifficulty = 'medium';
        
        let players = [];
        let obstacles = [];
        let projectiles = []; 
        let particles = [];
        let engineParticles = [];
        let frameCount = 0;
        let gameBackground; 

        // Input State
        let mouseY = canvas.height / 2;
        let isMouseDown = false;
        const keys = {
            p1Up: false, p1Down: false, p1Shoot: false
        };

        let currentProblem = null;
        let missionProgress = 0;
        const missionTarget = 10;
        const kingdomOrder = ['tambah', 'kurang', 'kali', 'bagi', 'pangkat2', 'akar3'];
        const kingdomNames = { 'tambah':'Penjumlahan', 'kurang':'Pengurangan', 'kali':'Perkalian', 'bagi':'Pembagian', 'pangkat2':'Pangkat 2', 'akar3':'Akar Pangkat 3' };

        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function toggleFullscreen() {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err=>{}); } 
            else { if (document.exitFullscreen) document.exitFullscreen(); }
        }

        function toggleMusic() {
            isMusicOn = !isMusicOn;
            const btns = document.querySelectorAll('#btn-music');
            btns.forEach(b => b.innerText = isMusicOn ? "üéµ" : "üîá");
            if(isMusicOn) {
                if(isGameActive && !isPaused) playBattleMusic(); else playMenuMusic();
            } else {
                menuMusic.pause(); battleMusic.pause();
            }
        }
        function playMenuMusic() { if(isMusicOn) { battleMusic.pause(); battleMusic.currentTime=0; menuMusic.play().catch(()=>{}); } }
        function playBattleMusic() { if(isMusicOn) { menuMusic.pause(); menuMusic.currentTime=0; battleMusic.play().catch(()=>{}); } }
        function playSound(sfx) { if(isMusicOn && sfx) { sfx.currentTime = 0; sfx.play().catch(()=>{}); } }

        function showDevInfo() { document.getElementById('dev-info-overlay').style.display = 'flex'; if(isGameActive) isPaused = true; }
        function closeDevInfo() { document.getElementById('dev-info-overlay').style.display = 'none'; if(isGameActive) { isPaused = false; animate(); } }

        // --- CLASSES ---
        class Background {
            constructor() {
                this.stars = [];
                for(let i=0; i<100; i++) {
                    this.stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        size: Math.random() * 2 + 0.5,
                        speed: Math.random() * 3 + 1
                    });
                }
            }
            draw() {
                ctx.fillStyle = "white";
                this.stars.forEach(star => {
                    ctx.globalAlpha = Math.random() * 0.5 + 0.2;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.size, 0, Math.PI*2);
                    ctx.fill();
                    star.x -= star.speed;
                    if(star.x < 0) {
                        star.x = canvas.width;
                        star.y = Math.random() * canvas.height;
                    }
                });
                ctx.globalAlpha = 1;
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.size = Math.random()*5+2;
                this.speedX = Math.random()*6-3;
                this.speedY = Math.random()*6-3;
                this.color = color;
                this.life = 100;
            }
            update() { this.x+=this.speedX; this.y+=this.speedY; this.life-=4; }
            draw() {
                ctx.globalAlpha = this.life/100;
                ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        class Player {
            constructor(color) {
                this.color = color;
                this.width = 100;
                this.height = 60;
                this.x = 20;
                this.y = canvas.height/2;
                this.speed = 8;
                this.frame = 0;
                this.shootCooldown = 0;
            }

            update() {
                let moveY = 0;
                if (keys.p1Up) { moveY = -this.speed; mouseY = this.y - this.speed; }
                else if (keys.p1Down) { moveY = this.speed; mouseY = this.y + this.speed; }
                else {
                    let targetY = mouseY - this.height/2;
                    moveY = (targetY - this.y) * 0.15; 
                }

                if (keys.p1Shoot && this.shootCooldown <= 0) this.shoot();

                this.y += moveY;
                if (this.shootCooldown > 0) this.shootCooldown--;
                if (this.y < 0) this.y = 0;
                if (this.y > canvas.height - this.height) this.y = canvas.height - this.height;
            }

            draw() {
                this.frame++;
                if (this.frame % 3 === 0) {
                    engineParticles.push(new Particle(this.x + 15, this.y + this.height/2 + 2, 'rgba(0, 200, 255, 0.7)'));
                }

                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + this.height/2);
                ctx.scale(0.8, 0.8);

                let mainColor = '#0096e7'; 
                let accentColor = '#e74c3c';

                ctx.fillStyle = accentColor;
                ctx.beginPath(); ctx.moveTo(-50, -10); ctx.lineTo(-80, -45); ctx.lineTo(-20, -10); ctx.fill();
                ctx.beginPath(); ctx.moveTo(-50, 10); ctx.lineTo(-80, 45); ctx.lineTo(-20, 10); ctx.fill();
                
                ctx.fillStyle = '#333'; ctx.beginPath(); ctx.ellipse(-55, 0, 12, 18, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#00e5ff'; ctx.beginPath(); ctx.ellipse(-58, 0, 5, 10, 0, 0, Math.PI*2); ctx.fill();

                let gradBody = ctx.createLinearGradient(-60, 0, 60, 0);
                gradBody.addColorStop(0, '#333'); gradBody.addColorStop(0.2, mainColor); gradBody.addColorStop(1, '#fff'); 
                ctx.fillStyle = gradBody;
                ctx.beginPath(); ctx.moveTo(-60, -10); ctx.lineTo(70, 5); ctx.lineTo(-50, 15); ctx.lineTo(-60, 10); ctx.closePath(); ctx.fill(); ctx.stroke();

                ctx.fillStyle = 'rgba(135, 206, 250, 0.8)'; 
                ctx.beginPath(); ctx.moveTo(10, -12); ctx.quadraticCurveTo(30, -15, 40, -5); ctx.lineTo(10, -5); ctx.fill(); ctx.strokeStyle = '#fff'; ctx.stroke();
                
                ctx.fillStyle = mainColor;
                ctx.beginPath(); ctx.moveTo(-20, 0); ctx.lineTo(-50, 30); ctx.lineTo(10, 5); ctx.fill(); ctx.stroke();

                ctx.fillStyle = accentColor; ctx.fillRect(-10, 30, 20, 4); 

                ctx.fillStyle = '#0096e7'; ctx.beginPath(); ctx.arc(20, -8, 5, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(22, -8, 4, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#e74c3c'; ctx.beginPath(); ctx.arc(24, -8, 1.5, 0, Math.PI*2); ctx.fill();

                if (currentProblem) {
                    ctx.font = "bold 24px Fredoka One";
                    ctx.fillStyle = "#FFEB3B"; 
                    ctx.strokeStyle = "black";
                    ctx.lineWidth = 4;
                    ctx.textAlign = "center";
                    ctx.strokeText(`${currentProblem.q} = ?`, 0, -60);
                    ctx.fillText(`${currentProblem.q} = ?`, 0, -60);
                }

                ctx.restore();
            }

            shoot() {
                this.shootCooldown = 20;
                playSound(sfxLaser);
                projectiles.push(new Projectile(this.x + this.width, this.y + this.height/2));
            }
        }
        
        class Projectile {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.width = 20; this.height = 6; this.speed = 15;
                this.markedForDeletion = false;
            }
            update() { this.x += this.speed; if(this.x > canvas.width) this.markedForDeletion = true; }
            draw() {
                ctx.fillStyle = '#00e5ff';
                ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 10;
                ctx.fillRect(this.x, this.y - 3, this.width, this.height);
                ctx.shadowBlur = 0;
            }
        }

        class Alien {
            constructor(val) {
                this.width = 80;
                this.height = 50;
                this.x = canvas.width + 100;
                this.y = Math.random() * (canvas.height - 150) + 80;
                this.val = val;
                this.markDel = false;
                this.floatOffset = Math.random() * 100;
                
                this.hullColor = Math.random() > 0.5 ? '#8e44ad' : '#2c3e50'; 
                this.domeColor = Math.random() > 0.5 ? '#2ecc71' : '#e74c3c';
            }
            update() {
                this.x -= gameSpeed;
                if(this.x < -this.width) {
                    this.markDel = true;
                }
            }
            draw() {
                let floatY = Math.sin((frameCount + this.floatOffset) * 0.1) * 3;
                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + floatY + this.height/2);
                ctx.scale(0.9, 0.9);
                
                ctx.fillStyle = '#bdc3c7';
                ctx.beginPath(); ctx.ellipse(-20, 20, 4, 8, 0.2, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.ellipse(20, 20, 4, 8, -0.2, 0, Math.PI*2); ctx.fill();

                ctx.fillStyle = 'rgba(173, 216, 230, 0.6)'; 
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(0, 0, 25, Math.PI, 0); ctx.fill(); ctx.stroke();
                
                ctx.fillStyle = this.hullColor;
                ctx.strokeStyle = '#ecf0f1'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.ellipse(0, 5, 45, 15, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();

                const lightCount = 5;
                for(let i=0; i<lightCount; i++) {
                    let angle = (i / (lightCount-1)) * Math.PI;
                    let lx = Math.cos(angle) * 35; 
                    let ly = Math.sin(angle) * 10 + 5;
                    let blink = Math.sin(frameCount * 0.2 + i) > 0;
                    ctx.fillStyle = blink ? this.domeColor : '#34495e';
                    ctx.beginPath(); ctx.arc(lx, ly + 2, 4, 0, Math.PI*2); ctx.fill();
                }

                ctx.fillStyle = '#27ae60'; ctx.beginPath(); ctx.arc(0, -5, 10, 0, Math.PI, true); ctx.fill();
                ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(-4, -8, 2, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(4, -8, 2, 0, Math.PI*2); ctx.fill();

                ctx.fillStyle = 'white'; ctx.font = 'bold 26px Fredoka One'; 
                ctx.textAlign = 'center'; ctx.shadowColor = 'black'; ctx.shadowBlur = 4;
                ctx.fillText(this.val, 0, 50); ctx.shadowBlur = 0;

                ctx.restore();
            }
        }

        // --- GAME LOGIC ---
        function enterMap() {
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(()=>{});
            
            if(isMusicOn) {
                battleMusic.pause();
                menuMusic.play().catch(()=>{});
            }

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('map-screen').style.display = 'block';
            
            const arcadeScore = document.getElementById('score-display');
            const hint = document.getElementById('controls-hint');

            arcadeScore.style.display = 'block';
            hint.style.display = "block";

            lives = 3; 
            score = 0; missionProgress = 0;
        }

        function setGlobalDifficulty(level) {
            currentDifficulty = level;
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            let id = level==='easy'?'diff-easy':(level==='medium'?'diff-med':'diff-hard');
            document.getElementById(id).classList.add('active');
            gameSpeed = level==='easy'?0.6:(level==='medium'?1.0:1.8);
        }

        function startAdventure(topic) {
            currentTopic = topic;
            document.getElementById('map-screen').style.display = 'none';
            document.getElementById('level-clear-overlay').style.display = 'none';
            
            const layer = document.getElementById('portal-layer');
            const img = document.getElementById('portal-image');
            layer.style.display = 'flex';
            
            let f = 0;
            let anim = setInterval(() => { img.src = portalImages[f++ % 4]; }, 250);
            
            setTimeout(() => {
                clearInterval(anim);
                layer.style.display = 'none';
                startGame();
            }, 3000);
        }

        function startGame() {
            if(isMusicOn) { menuMusic.pause(); battleMusic.currentTime=0; battleMusic.play().catch(()=>{}); }
            
            players = [];
            obstacles = [];
            projectiles = [];
            particles = [];
            engineParticles = [];
            missionProgress = 0;
            score = 0;

            players.push(new Player('#0096e7'));
            gameBackground = new Background();
            
            updateHUD();
            document.getElementById('btn-home').style.display = 'block';
            document.getElementById('question-panel').style.display = 'none'; 
            document.getElementById('controls-hint').style.display = 'block'; 

            generateProblem(); 
            isPaused = false;
            isGameActive = true;
            
            animate();
        }

        function r(max, min=0) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        function generateProblem() {
            let maxVal = currentDifficulty === 'easy' ? 10 : (currentDifficulty === 'medium' ? 30 : 50);
            let num1, num2, ans, str;
            
            switch(currentTopic) {
                case 'tambah': num1=r(maxVal,1); num2=r(maxVal,1); ans=num1+num2; str=`${num1} + ${num2}`; break;
                case 'kurang': num1=r(maxVal,5); num2=r(num1,1); ans=num1-num2; str=`${num1} - ${num2}`; break;
                case 'kali': num1=r(10,1); num2=r(10,1); ans=num1*num2; str=`${num1} √ó ${num2}`; break;
                case 'bagi': ans=r(10,1); num2=r(10,1); num1=ans*num2; str=`${num1} √∑ ${num2}`; break;
                case 'pangkat2': num1=r(12,1); ans=num1*num1; str=`${num1}¬≤`; break;
                case 'akar3': let c=[1,8,27,64,125,216,343]; let v=c[r(c.length-1)]; ans=Math.cbrt(v); str=`¬≥‚àö${v}`; break;
            }
            
            currentProblem = { q: str, answer: ans };
            spawnWave();
        }
        
        function generateWrongOption(c) {
            let w; do { w = c + r(5, -5); } while(w===c || w<0); return w;
        }

        function spawnWave() {
            if (!currentProblem) return;
            
            let correct = currentProblem.answer;
            let wrong1 = generateWrongOption(correct);
            let wrong2 = generateWrongOption(correct);
            while (wrong2 === wrong1) wrong2 = generateWrongOption(correct);
            
            let options = [correct, wrong1, wrong2];
            options.sort(() => Math.random() - 0.5); 
            
            let zones = [canvas.height * 0.2, canvas.height * 0.5, canvas.height * 0.8];
            
            options.forEach((val, index) => {
                let y = zones[index] + (Math.random() * 60 - 30); 
                let a = new Alien(val);
                a.y = y;
                a.x = canvas.width + 150 + (index * 60); 
                obstacles.push(a);
            });
        }

        window.addEventListener('keydown', (e) => {
            if (!isGameActive || isPaused) return;
            if (e.code === 'KeyW' || e.code === 'ArrowUp') keys.p1Up = true;
            if (e.code === 'KeyS' || e.code === 'ArrowDown') keys.p1Down = true;
            if (e.code === 'Space') keys.p1Shoot = true;
        });

        window.addEventListener('keyup', (e) => {
            if (!isGameActive) return;
            if (e.code === 'KeyW' || e.code === 'ArrowUp') keys.p1Up = false;
            if (e.code === 'KeyS' || e.code === 'ArrowDown') keys.p1Down = false;
            if (e.code === 'Space') keys.p1Shoot = false;
        });

        function handleInputStart(x, y) {
            if (!isGameActive || isPaused) return;

            let clickedAlien = null;
            for(let alien of obstacles) {
                if (!alien) continue;
                const padding = 30; 
                if (x >= alien.x - padding && x <= alien.x + alien.width + padding &&
                    y >= alien.y - padding && y <= alien.y + alien.height + padding) {
                    clickedAlien = alien;
                    break;
                }
            }

            if (clickedAlien) {
                const targetY = clickedAlien.y + clickedAlien.height/2;
                mouseY = targetY;
                if(players[0]) {
                    players[0].y = targetY - players[0].height/2;
                    players[0].shoot();
                }
            } else {
                isMouseDown = false;
            }
        }

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            handleInputStart(e.clientX - rect.left, e.clientY - rect.top);
        });

        canvas.addEventListener('touchstart', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left;
            const y = e.touches[0].clientY - rect.top;
            handleInputStart(x, y);
        }, {passive: false});

        canvas.addEventListener('mouseup', () => isMouseDown = false);
        canvas.addEventListener('touchend', () => isMouseDown = false);

        function handleMove(y) {
            if (!isGameActive || isPaused) return;
            mouseY = y;
        }

        window.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            handleMove(e.clientY - rect.top);
        });

        window.addEventListener('touchmove', (e) => {
            if (!isGameActive) return;
            if(e.target === canvas) e.preventDefault(); 
            const rect = canvas.getBoundingClientRect();
            handleMove(e.touches[0].clientY - rect.top);
        }, {passive: false});


        function checkAnswer(alien) {
            if (!alien || !currentProblem) return;
            
            createExplosion(alien.x, alien.y);
            const idx = obstacles.indexOf(alien);
            if (idx > -1) obstacles.splice(idx, 1);

            if (alien.val === currentProblem.answer) {
                playSound(sfxCorrect);
                score += 10;
                missionProgress++;
                updateHUD();
                feedback("HEBAT!", "#2ecc71");
                
                obstacles = []; 

                if (missionProgress >= 10) {
                    levelClear();
                } else {
                    generateProblem();
                }
            } else {
                playSound(sfxWrong);
                lives--;
                updateHUD();
                if (lives <= 0) gameOver();
                feedback("SALAH!", "#e74c3c");
                obstacles = [];
                generateProblem();
            }
        }

        function createExplosion(x, y) {
            playSound(sfxExplosion);
            for(let i=0; i<15; i++) particles.push(new Particle(x+35, y+35, 'orange'));
        }

        function levelClear() {
            isPaused = true;
            document.getElementById('level-clear-overlay').style.display = 'flex';
            let idx = kingdomOrder.indexOf(currentTopic);
            let next = kingdomOrder[idx+1];
            
            let title = document.getElementById('level-clear-title');
            let text = document.getElementById('level-clear-text');
            title.innerText = `${kingdomNames[currentTopic]} Selesai!`;

            if(next) {
                text.innerText = `Menuju: ${kingdomNames[next]}...`;
                setTimeout(()=>{
                    document.getElementById('level-clear-overlay').style.display = 'none';
                    startAdventure(next);
                }, 3000);
            } else {
                alert("SELAMAT! SEMUA KERAJAAN SELESAI!");
                backToMap();
            }
        }

        function gameOver() {
            isPaused = true;
            alert(`GAME OVER! Skor: ${score}`);
            backToMap();
        }

        function backToMap() {
            isGameActive = false; isPaused = true;
            playMenuMusic();
            cancelAnimationFrame(animationId);
            
            document.getElementById('map-screen').style.display='block';
            document.getElementById('btn-home').style.display='none';
            document.getElementById('level-clear-overlay').style.display='none';
            document.getElementById('shooting-overlay').style.display='none';
            document.getElementById('controls-hint').style.display='none';
        }

        function updateHUD() {
            let l = Math.max(0, lives);
            document.getElementById('lives-display').innerText = "‚ù§Ô∏è ".repeat(l); 
            document.getElementById('mission-display').innerText = `Misi: ${missionProgress}/${missionTarget}`;
            document.getElementById('score-display').innerText = `Poin: ${score}`;
        }

        function feedback(t, c) {
            let el = document.getElementById('feedback-overlay');
            el.innerText = t; el.style.color = c; el.style.display = 'block';
            setTimeout(()=>el.style.display='none', 800);
        }

        function animate() {
            if(isPaused) return;
            ctx.clearRect(0,0,canvas.width, canvas.height);
            
            if(gameBackground) gameBackground.draw();

            frameCount++;

            for(let i=engineParticles.length-1; i>=0; i--) {
                engineParticles[i].x -= 2; engineParticles[i].update(); engineParticles[i].draw();
                if(engineParticles[i].life<=0) engineParticles.splice(i,1);
            }
            for(let i=particles.length-1; i>=0; i--) {
                particles[i].update(); particles[i].draw();
                if(particles[i].life<=0) particles.splice(i,1);
            }

            players.forEach(p => { p.update(); p.draw(); });

            let answerCheckedThisFrame = false;
            for(let i=projectiles.length-1; i>=0; i--) {
                let p = projectiles[i];
                p.update(); p.draw();
                for(let j=obstacles.length-1; j>=0; j--) {
                    let o = obstacles[j];
                    if (!o) continue;
                    if (p.x > o.x && p.x < o.x+o.width && p.y > o.y && p.y < o.y+o.height) {
                        checkAnswer(o);
                        p.markedForDeletion = true;
                        answerCheckedThisFrame = true;
                        break;
                    }
                }
                if(p.markedForDeletion) projectiles.splice(i, 1);
                if(answerCheckedThisFrame) break; 
            }

            if (obstacles.length === 0 && currentProblem && isGameActive && !isPaused && missionProgress < missionTarget) {
               spawnWave();
            }

            for(let i=obstacles.length-1; i>=0; i--) {
                let o = obstacles[i];
                if (!o) continue;
                o.update(); o.draw();
                if (players[0]) {
                     if (o.x < players[0].x+players[0].width && o.x+o.width > players[0].x && o.y < players[0].y+players[0].height && o.y+o.height > players[0].y) {
                        createExplosion(o.x, o.y); 
                        obstacles.splice(i,1); 
                        continue;
                     }
                }
                if(o.markDel) {
                    obstacles.splice(i,1);
                    lives--;
                    updateHUD();
                    feedback("LOLOS!", "#f39c12");
                    if (lives <= 0) gameOver();
                }
            }
            
            animationId = requestAnimationFrame(animate);
        }
    </script>
</body>
</html>
